<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago con Tarjeta - LaTRONIC</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@200..700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #121212; color: #fff; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 50px 0; }
    .container { background: #1e1e1e; width: 420px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 25px; }
    h2 { text-align: center; margin-bottom: 20px; background: linear-gradient(to right, yellow, red); -webkit-background-clip: text; color: transparent; font-weight: 700; }
    .cart-summary { max-height: 250px; overflow-y: auto; margin-bottom: 15px; }
    .cart-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; background:#2a2a2a; padding:8px; border-radius:8px; }
    .cart-item img { width:50px; height:50px; object-fit:cover; border-radius:6px; margin-right:10px; }
    .cart-item-info { flex:1; margin-right:10px; }
    #totals { text-align:right; margin-bottom:15px; }
    #totals p { margin:3px 0; }
    #total-display { font-weight: bold; font-size: 1.1rem; }
    .input-group { margin-bottom: 12px; }
    .input-group label { font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 4px; }
    .input-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 0.9rem; }
    #card-container { margin: 20px 0; }
    #payment-status { margin-top: 15px; font-weight: bold; text-align: center; }
    button { width: 100%; padding: 12px; font-size: 16px; border-radius: 12px; border: none; cursor: pointer; background: #e28f2f; color: black; font-weight: 600; transition: 0.3s; }
    button.pay-button:hover { background:#f16413; color:white; }
    button:disabled { background: #555; cursor: not-allowed; }
    .back-home { font-family: "Bebas Neue", sans-serif; font-weight: 400; color: #fff; text-decoration: none; display:block; margin: 15px 0; text-align:center; }
    .back-home:hover { color: #f16413; }
    .small-paragraph { font-size: 10px; color:#ccc; }
    @media (max-width: 600px) { .container { width: 95%; padding: 15px; } h2 { font-size: clamp(20px, 6vw, 28px); } .input-group label, .input-group input { font-size: 0.85rem; } #card-container { margin: 15px 0; } button { font-size: 0.95rem; padding: 10px; } }
  </style>
</head>
<body>
<div class="container">
  <h2>Purchase summary</h2>
  <div class="cart-summary" id="cart-summary"></div>
  <div id="totals">
    <p>Subtotal: $<span id="subtotal">0.00</span></p>
    <p>Taxes: $<span id="taxes">0.00</span></p>
    <p id="total-display">Total: $0.00</p>
  </div>

  <div class="input-group">
    <label for="email">Email to receive tracking #</label>
    <input type="email" id="email" placeholder="example@email.com" required />
  </div>
  <div class="input-group">
    <label for="address">Shipping Address (number, street name, city & zipcode)</label>
    <input type="text" id="address" placeholder="123 Main St, City" required />
  </div>
  <div class="input-group">
    <label for="estado">State</label>
    <input type="text" id="estado" readonly />
  </div>

  <div id="card-container"></div>
  <input type="number" id="amount" style="display:none;" />
  <button id="pay-button" class="pay-button">Pay now</button>
  <a href="index.html" class="back-home">Back to menu</a>
  <div id="payment-status"></div>

  <h6 class="small-paragraph">
    Give us 24 hours from the date and time of purchase to process the shipment. We will provide you with the tracking number and send it to the email address you provided above. Please make sure to enter the shipping address correctly ‚Äî including street number, street name, city, state, and zip code ‚Äî so we can complete the delivery without any issues. Refunds are not accepted after 24 hours from the time of purchase. LaTRONIC LLC.
  </h6>
</div>

<script>
// --- Cargar carrito desde localStorage ---
function cargarCarrito() {
  const productos = JSON.parse(localStorage.getItem("productos-en-cart")) || [];
  const cartSummaryEl = document.getElementById("cart-summary");
  cartSummaryEl.innerHTML = "";

  let subtotal = 0;

  if (productos.length === 0) {
    cartSummaryEl.innerHTML = "<p>Your cart is empty üòû</p>";
  } else {
    productos.forEach(p => {
      const price = parseFloat(p.price) || 0;
      const quantity = parseInt(p.quantity) || 1;
      subtotal += price * quantity;

      const div = document.createElement("div");
      div.classList.add("cart-item");
      div.innerHTML = `
        <img src="${p.imagenes ? p.imagenes[0] : 'https://via.placeholder.com/50'}" alt="${p.titulo}">
        <div class="cart-item-info">
          <strong>${p.titulo}</strong><br>
          Price: $${price.toFixed(2)} x ${quantity}
        </div>
        <div><strong>$${(price * quantity).toFixed(2)}</strong></div>
      `;
      cartSummaryEl.appendChild(div);
    });
  }

  // Estado del cliente
  const estadoCliente = localStorage.getItem("estado-cliente") || "CT";
  document.getElementById("estado").value = estadoCliente;

  // TAX para CT
  let taxes = 0;
  const taxRateCT = 0.0635; 
  if (estadoCliente === "CT") {
    taxes = subtotal * taxRateCT;
  }

  const total = subtotal + taxes;

  // Mostrar
  document.getElementById("subtotal").textContent = subtotal.toFixed(2);
  document.getElementById("taxes").textContent = taxes.toFixed(2);
  document.getElementById("total-display").textContent = `Total: $${total.toFixed(2)}`;

  // Mandamos subtotal (el backend calcula impuestos de nuevo)
  document.getElementById("amount").value = subtotal;
}

cargarCarrito();
setInterval(cargarCarrito, 2000);

// --- Square Payments ---
async function initSquare() {
  try {
    const applicationId = "sq0idp--rNNME6Cy0VtaEKmHUTldQ"; // ‚ö†Ô∏è pon tu Square Application ID
    const locationId = "LBXYJCC3X1GRS"; // ‚ö†Ô∏è pon tu Location ID

    const payments = Square.payments(applicationId, locationId);
    const card = await payments.card();
    await card.attach("#card-container");

    const payButton = document.getElementById("pay-button");
    payButton.addEventListener("click", async function() {
      payButton.disabled = true;
      try {
        const result = await card.tokenize();
        if (result.status === "OK") {
          // Enviar al backend con los nombres correctos
          const res = await fetch("/process-payment", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    sourceId: result.token,
    total: document.getElementById("amount").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    estado: document.getElementById("estado").value
  })
});


          const data = await res.json();
          document.getElementById("payment-status").textContent =
            data.payment && data.payment.status === "COMPLETED"
              ? "‚úÖ Pago exitoso"
              : "‚ùå Error: " + (data.error || "Intenta de nuevo");
        } else {
          document.getElementById("payment-status").textContent =
            "‚ùå Error al tokenizar la tarjeta";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("payment-status").textContent = "‚ùå Error en el proceso";
      } finally {
        payButton.disabled = false;
      }
    });
  } catch (err) {
    console.error("Error al inicializar Square:", err);
  }
}

initSquare();
</script>
</body>
</html>
